@startuml
title Flood Prediction System - Inference Sequence Diagram

actor User

box "Flood Prediction System" #LightBlue
    participant "Gateway" as gateway
    participant "Inference Service" as inf
    participant "Flood Prediction Service" as fps
    participant "Alert Service" as alert
    participant "Database" as db
end box

participant "External API\n(Weather / Flow Data)" as ext

' ============================================================
' PERIODIC FLOOD PREDICTION (Inference-driven)
' ============================================================

loop Every 1 hour
    inf -> fps : GET /predict
    activate fps
        fps -> db : requestRawData()
        db -> ext : fetchExternalData()
        ext --> db : rawData
        db --> fps : preparedData

        fps -> fps : simulateFlood()
        fps --> inf : Prediction
    deactivate fps

    inf -> db : add_prediction(prediction)
    inf -> alert : POST /alertUsers (Prediction)
    activate alert

    alt prediction.severity < CRUE_SEVERITY_THRESHOLD
        alert --> inf : 200 No alert (severity too low)
    else prediction.severity >= CRUE_SEVERITY_THRESHOLD
        alert -> db : get_all_users()
        db --> alert : users

        alt users is empty
            alert --> inf : 404 No users to alert
        else users exist
            loop For each user
                alt user.mail exists
                    alert -> User : send email alert
                end
                alt user.ip exists
                    alert -> User : send IP alert
                end
            end

            alert --> inf : 200 Alert sent
        end
    end

    deactivate alert

end loop

@enduml
