@startuml
title Flood Prediction System - Complete Sequence Diagram

actor User

box "Flood Prediction System" #LightBlue
    participant "Gateway" as s1
    participant "Alert Service" as s4
    participant "ML Prediction Service" as s2
    participant "Data Service" as s3
    participant "GIS Service" as gis
    participant "Scheduler <<Timer>>" as sched
    participant "Data Cleaning Service" as clean
end box

participant "External API\n(Data Sources)" as ext

' ============================================================
' PERIODIC FLOOD SIMULATION
' ============================================================

group Loop [Periodically]
    sched -> s2 : triggerRunSimulation()
    activate s2
        s2 -> s3 : requestRawData()
        s3 -> ext : fetchExternalData()
        ext --> s3 : provideRawData()

        s3 -> clean : clean(rawData)
        clean --> s3 : cleanedData

        s3 --> s2 : return cleanedData

        s2 -> s2 : simulateFlood()
        s2 -> s3 : saveFloodData(floodStatus, floodDetected)
    deactivate s2

    s3 --> s1 : updateFloodStatus(floodStatus, floodDetected)
end group


' ============================================================
' USER SUBSCRIBES TO ALERTS
' ============================================================

User -> s1 : subscribeToAlerts()
s1 -> s4 : registerSubscription(user)
s4 --> s1 : subscriptionConfirmed
s1 --> User : return subscribed


' ============================================================
' ALERT FLOW
' ============================================================

group opt [floodDetected == true]
    s3 -> s4 : floodDetectedNotification(floodStatus)

    group alt [userSubscribed == true]
        s4 -> s4 : checkUserSubscription()
        s4 -> User : sendFloodAlert()
    end
end group


' ============================================================
' USER CHECKS FLOOD STATUS
' ============================================================

User -> s1 : checkFloodStatus()
s1 -> s3 : getCurrentFloodStatus()
s3 --> s1 : return floodStatus
s1 --> User : showFloodStatus()


' ============================================================
' USER CONSULTS GIS DETAILS
' ============================================================

User -> s1 : consultFloodDetails()
s1 -> gis : getSegmentDetails()
gis --> s1 : return segmentDetails
s1 --> User : displaySegmentDetails()

@enduml
